<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koululaisten ruokatottumukset - Analyysi</title>
    <link rel="stylesheet" href="mainstyles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            color: #000;
            background: #f8f8f8;
            font-family: 'PT Serif', serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007acc;
        }
        
        .nav-link {
            color: #007acc;
            text-decoration: none;
            margin-top: 20px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìä Koululaisten ruokatottumukset</h1>
        <p>Analyysi 20 000 rivin datasetist√§ koululaisten ruokatottumuksista eri maissa</p>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-records">-</div>
                <div>Datapisteit√§</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="countries-count">-</div>
                <div>Maata</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activities-count">-</div>
                <div>Ruokatottumusta</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-value">-</div>
                <div>Keskiarvo %</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Sukupuolierot ruokatottumuksissa</div>
            <div id="gender-chart" class="loading">Ladataan dataa...</div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Top 10 maata - Parhaat ruokatottumukset</div>
            <div id="countries-chart" class="loading">Ladataan dataa...</div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Ruokailutiheys - Jakauma</div>
            <div id="frequency-chart" class="loading">Ladataan dataa...</div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Ruokatottumukset ik√§ryhmitt√§in</div>
            <div id="age-chart" class="loading">Ladataan dataa...</div>
        </div>

        <nav style="margin-top: 40px;">
            <a href="Experimental-pages.html" class="nav-link">‚Üê Takaisin experimental pages</a>
        </nav>
    </div>

    <script>
        // Ladataan ja k√§sitell√§√§n CSV-data
        async function loadAndAnalyzeData() {
            try {
                // Ladataan CSV-data
                const response = await fetch('./assets/Data/13100194.csv');
                const csvText = await response.text();
                
                // Parsitaan CSV (yksinkertainen parser semicolon-separoidulle datalle)
                const lines = csvText.split('\\n');
                const headers = lines[0].split(';').map(h => h.replace(/"/g, ''));
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(';').map(v => v.replace(/"/g, ''));
                        if (values.length === headers.length) {
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index];
                            });
                            data.push(row);
                        }
                    }
                }
                
                // Suodatetaan ja puhdistetaan data
                const cleanData = data.filter(row => {
                    const value = parseFloat(row['VALEUR']);
                    return !isNaN(value) && value > 0;
                }).map(row => ({
                    ...row,
                    VALEUR: parseFloat(row['VALEUR'])
                }));
                
                console.log('Data ladattu:', cleanData.length, 'rivi√§');
                
                // P√§ivitet√§√§n tilastot
                updateStats(cleanData);
                
                // Luodaan visualisoinnit
                createGenderChart(cleanData);
                createCountriesChart(cleanData);
                createFrequencyChart(cleanData);
                createAgeChart(cleanData);
                
            } catch (error) {
                console.error('Virhe datan lataamisessa:', error);
                document.querySelectorAll('.loading').forEach(el => {
                    el.innerHTML = 'Virhe datan lataamisessa. Tarkista ett√§ CSV-tiedosto on saatavilla.';
                });
            }
        }

        function updateStats(data) {
            const totalRecords = data.length;
            const countriesCount = new Set(data.map(d => d['G√âO'])).size;
            const activitiesCount = new Set(data.map(d => d['Activit√©'])).size;
            const avgValue = data.reduce((sum, d) => sum + d.VALEUR, 0) / data.length;

            document.getElementById('total-records').textContent = totalRecords.toLocaleString();
            document.getElementById('countries-count').textContent = countriesCount;
            document.getElementById('activities-count').textContent = activitiesCount;
            document.getElementById('avg-value').textContent = avgValue.toFixed(1) + '%';
        }

        function createGenderChart(data) {
            // Ryhmitell√§√§n data sukupuolen ja aktiviteetin mukaan
            const genderData = {};
            data.forEach(row => {
                const gender = row['Sexe'];
                const activity = row['Activit√©'];
                const value = row['VALEUR'];
                
                if (!genderData[gender]) genderData[gender] = {};
                if (!genderData[gender][activity]) genderData[gender][activity] = [];
                genderData[gender][activity].push(value);
            });

            // Lasketaan keskiarvot
            const traces = [];
            const activities = new Set();
            
            Object.keys(genderData).forEach(gender => {
                Object.keys(genderData[gender]).forEach(activity => {
                    activities.add(activity);
                });
            });

            Object.keys(genderData).forEach(gender => {
                const x = [];
                const y = [];
                
                activities.forEach(activity => {
                    if (genderData[gender][activity]) {
                        const avg = genderData[gender][activity].reduce((a, b) => a + b, 0) / genderData[gender][activity].length;
                        x.push(activity);
                        y.push(avg);
                    }
                });

                traces.push({
                    x: x,
                    y: y,
                    name: gender,
                    type: 'bar'
                });
            });

            const layout = {
                title: '',
                xaxis: { title: 'Ruokatottumukset' },
                yaxis: { title: 'Prosentti (%)' },
                barmode: 'group'
            };

            Plotly.newPlot('gender-chart', traces, layout);
        }

        function createCountriesChart(data) {
            // Ryhmitell√§√§n maan mukaan ja lasketaan keskiarvot
            const countryData = {};
            data.forEach(row => {
                const country = row['G√âO'];
                const value = row['VALEUR'];
                
                if (!countryData[country]) countryData[country] = [];
                countryData[country].push(value);
            });

            // Lasketaan keskiarvot ja otetaan top 10
            const countryAvgs = Object.keys(countryData).map(country => ({
                country: country,
                avg: countryData[country].reduce((a, b) => a + b, 0) / countryData[country].length
            })).sort((a, b) => b.avg - a.avg).slice(0, 10);

            const trace = {
                x: countryAvgs.map(d => d.country),
                y: countryAvgs.map(d => d.avg),
                type: 'bar',
                marker: { color: 'rgb(55, 128, 191)' }
            };

            const layout = {
                title: '',
                xaxis: { title: 'Maa' },
                yaxis: { title: 'Keskiarvo (%)' }
            };

            Plotly.newPlot('countries-chart', [trace], layout);
        }

        function createFrequencyChart(data) {
            // Ryhmitell√§√§n frekvenssin mukaan
            const freqData = {};
            data.forEach(row => {
                const freq = row['Fr√©quence'];
                const value = row['VALEUR'];
                
                if (!freqData[freq]) freqData[freq] = [];
                freqData[freq].push(value);
            });

            // Lasketaan keskiarvot
            const labels = [];
            const values = [];
            
            Object.keys(freqData).forEach(freq => {
                const avg = freqData[freq].reduce((a, b) => a + b, 0) / freqData[freq].length;
                labels.push(freq);
                values.push(avg);
            });

            const trace = {
                labels: labels,
                values: values,
                type: 'pie'
            };

            const layout = {
                title: ''
            };

            Plotly.newPlot('frequency-chart', [trace], layout);
        }

        function createAgeChart(data) {
            // Ryhmitell√§√§n i√§n ja aktiviteetin mukaan
            const ageData = {};
            data.forEach(row => {
                const age = row["Groupe d'√¢ge"];
                const activity = row['Activit√©'];
                const value = row['VALEUR'];
                
                if (!ageData[activity]) ageData[activity] = {};
                if (!ageData[activity][age]) ageData[activity][age] = [];
                ageData[activity][age].push(value);
            });

            // Luodaan viivat jokaiselle aktiviteetille
            const traces = [];
            const ages = new Set();
            
            // Ker√§t√§√§n kaikki ik√§ryhm√§t
            Object.keys(ageData).forEach(activity => {
                Object.keys(ageData[activity]).forEach(age => {
                    ages.add(age);
                });
            });

            const sortedAges = Array.from(ages).sort();

            Object.keys(ageData).slice(0, 5).forEach(activity => { // Rajoitetaan 5 aktiviteettiin
                const x = [];
                const y = [];
                
                sortedAges.forEach(age => {
                    if (ageData[activity][age]) {
                        const avg = ageData[activity][age].reduce((a, b) => a + b, 0) / ageData[activity][age].length;
                        x.push(age);
                        y.push(avg);
                    }
                });

                if (x.length > 0) {
                    traces.push({
                        x: x,
                        y: y,
                        name: activity,
                        type: 'scatter',
                        mode: 'lines+markers'
                    });
                }
            });

            const layout = {
                title: '',
                xaxis: { title: 'Ik√§ryhm√§' },
                yaxis: { title: 'Prosentti (%)' }
            };

            Plotly.newPlot('age-chart', traces, layout);
        }

        // Ladataan data kun sivu latautuu
        document.addEventListener('DOMContentLoaded', loadAndAnalyzeData);
    </script>
</body>
</html>
